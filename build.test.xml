<!-- run with: 
	ant compile
	ant -f build.test.xml start-ec2 
-->
<project name="test-aws-tasks" default="test-ec2">
    
	<property name="root.dir" value="${basedir}" />
	<property file="${root.dir}/src/build/ant/build.properties" />
	<property file="${root.dir}/src/it/resources/ec2.properties" />
	
	
	<!-- ================================================================== -->
	<!-- CLASSPATH 				                                            -->
	<!-- ================================================================== -->
	
	<path id="task.classpath">
		<pathelement location="${build.dir.main-classes}" />
		<pathelement location="${main.res.dir}" />
		<fileset dir="${lib.dir}/compile">
			<include name="**/*.jar" />
		</fileset>
		<fileset dir="${lib.dir}/provided">
			<include name="**/*.jar" />
		</fileset>
	</path>
	
	
	<!-- ================================================================== -->
	<!-- AWS TASKS DEFINITION	                                            -->
	<!-- ================================================================== -->
	
	<taskdef name="ec2-start" classname="com.dm.awstasks.ec2.ant.Ec2StartTask" classpathref="task.classpath"/>
	<taskdef name="ec2-stop" classname="com.dm.awstasks.ec2.ant.Ec2StopTask" classpathref="task.classpath"/>
	<taskdef name="ec2-ssh" classname="com.dm.awstasks.ec2.ant.Ec2SshTask" classpathref="task.classpath"/>

	
	<!-- ================================================================== -->
	<!-- START EC2 EXAMPLE TASK	                                            -->
	<!-- ================================================================== -->
	<target name="start-ec2" description="--> start ec2 instance groups">
		<ec2-start groupName="aws-tasks.test"
			ami="ami-5059be39"
			instanceCount="2"
			accessKey="${ec2.accessKey}"
			accessSecret="${ec2.accessSecret}"
			privateKeyName="${ec2.privateKeyName}">
		</ec2-start>
	</target>
	
	<!-- ================================================================== -->
	<!-- PREPARE EC2 EXAMPLE TASK: some ssh/scp commands right after instance startup -->
	<!-- ================================================================== -->
	<target name="prepare-ec2" description="--> prepare fresh ec2 instance groups">
		<ec2-ssh groupName="aws-tasks.test"
			accessKey="${ec2.accessKey}"
			accessSecret="${ec2.accessSecret}"
			username="ubuntu"
			keyfile="${ec2.privateKeyFile}">
			<upload localFile="build.xml" remotePath="uploadedFile" targetInstances="all"/>
			<upload localFile="src/build" remotePath="~/" targetInstances="0"/>
			<exec command="ls uploadedFile"/>
			<exec command="hostname"/>
		</ec2-ssh>
	</target>
	
	<!-- ================================================================== -->
	<!-- DISMANTLE EC2 EXAMPLE TASK: some ssh/scp commands right before instance shutdown -->
	<!-- ================================================================== -->
	<target name="dismantle-ec2" description="--> prepare fresh ec2 instance groups">
		<property name="downloadDir" value="${build.dir}/testDownload"/>
		<mkdir dir="${downloadDir}"/>
		<ec2-ssh groupName="aws-tasks.test"
			accessKey="${ec2.accessKey}"
			accessSecret="${ec2.accessSecret}"
			username="ubuntu"
			keyfile="${ec2.privateKeyFile}">
			<download remotePath="uploadedFile" localFile="${downloadDir}/build.xml" targetInstances="all"/>
			<download remotePath="build" localFile="${downloadDir}/" recursiv="true" targetInstances="0"/>
		</ec2-ssh>
	</target>
	
	<!-- ================================================================== -->
	<!-- STOP EC2 EXAMPLE TASK	                                            -->
	<!-- ================================================================== -->
	<target name="stop-ec2" description="--> stop ec2 instance groups">
		<ec2-stop groupName="aws-tasks.test"
			accessKey="${ec2.accessKey}"
			accessSecret="${ec2.accessSecret}">
		</ec2-stop>
	</target>
	
	<!-- ================================================================== -->
	<!-- TEST EC2 EXAMPLE TASKs	                                            -->
	<!-- ================================================================== -->
	<target name="test-ec2" depends="start-ec2, prepare-ec2, stop-ec2" description="--> test all ec2 tasks">
		<echo>fin running ec2 tasks</echo>
	</target>
	
</project>
